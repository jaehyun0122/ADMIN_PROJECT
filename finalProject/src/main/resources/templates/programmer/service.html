<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>서비스</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</head>
<body>
<th:block th:replace="common/header :: navBar"/>

  <!--  wrapper -->
  <div class="container my-5">
    <!--정렬, 등록 버튼-->
    <div class="d-flex flex-row-reverse">

      <div style="padding: 10px">
        <a type="button" class="btn btn-secondary" th:href="@{service/register}">등록</a>
      </div>

      <div style="padding: 10px">
        <select class="form-select form-select-sm" aria-label=".form-select-sm example">
          <option value="all" selected>전체</option>
          <option value="0">대기</option>
          <option value="1">승인</option>
          <option value="2">반려</option>
        </select>
      </div>

    </div>
    <!-- End 정렬, 등록 버튼-->

    <!-- 테이블   -->
    <div class="row justify-content-center">
      <table class="table">
        <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">회사명</th>
          <th scope="col">상태</th>
          <th scope="col">승인 시간</th>
          <th scope="col">신청 시간</th>
        </tr>
        </thead>
        <tbody id="body">
          <tr th:each="service, index : ${serviceList}">
            <th scope="row" th:text="${index.index}+1">목록 번호</th>
            <td th:text="${service.getCompanyName()}">회사 이름</td>
            <th:block th:switch="${service.getIsPermit()}">
              <td th:case="'0'">대기중</td>
              <td th:case="'1'">승인</td>
              <td th:case="'2'">반려</td>
            </th:block>
            <td th:text="${service.getPermitAt()}">승인 시간</td>
            <td th:text="${service.getRegAt()}">등록 시간</td>
          </tr>
        </tbody>
      </table>
  </div>
  <!-- End 테이블   -->
</div>
<!-- End wrapper -->

</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>

  $(document).ready(function (){
    $.ajax({
      url: "/service",
      type: "POST",
      data: JSON.stringify({ "status": "all" }),
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      beforeSend: function(xhr) {
        xhr.setRequestHeader($("meta[name='_csrf_header']").attr("content"), $("meta[name='_csrf']").attr("content"));
      },
      success: function(response) {
        console.log(response)
        changeBody(response)
      },
      error: function(xhr, status, error) {
        alert("요청 실패")
      }
    })
  })

  /*정렬 selection 변경 시 실행 되는 함수*/
  $('select').on('change', function() {
    // 전체 : 0 ,  대기 : 1 , 승인 : 2 , 반려 : 3
    let selectedValue = $(this).val();

      $.ajax({
        url: "/service",
        type: "POST",
        data: JSON.stringify({ "status": selectedValue }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        beforeSend: function(xhr) {
          xhr.setRequestHeader($("meta[name='_csrf_header']").attr("content"), $("meta[name='_csrf']").attr("content"));
        },
        success: function(response) {
          changeBody(response)
        },
        error: function(xhr, status, error) {
          alert("요청 실패")
        }
      })


  });

  /**
   * 변경 table body 만들어주는 함수
   * @param type
   */
  function changeBody(response){
    let body = "<tr>";
    response.map((row, idx) => {
      body += `
        <th scope="row">${idx+1}</th>
        <th scope="row">${row.companyName}</th>
        `
      switch (row.isPermit){
        case 0 :
          body += `<td>대기중</td>`;
          break;
        case 1 :
          body += `<th scope="row">승인</th>`;
          break;
        case 2 :
          body += `<td>반려</td>`;
          break;
      }
      if(row.permitAt == null){
        body += "<td></td>"
      }else{
        body += `<td>${row.permitAt}</td>`
      }
      body += `
        <td>${row.regAt}</td>
        </tr>`
    })

    $("#body").empty();
    $("#body").append(body);

  }
</script>
</html>